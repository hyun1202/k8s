# 잡
## 잡의 종류
- 단일 잡
  - 파드 하나만 실행
  - 파드가 정상적으로 실행 종료되면 잡 실행 완료 (Succeeded)
  - .spec.completions와 .spec.parallelism 필드를 설정하지 않음 (기본 값 1)
    - completions: 정상적으로 실행 종료되어야 하는 파드의 개수
    - parallelism: 동시에 실행되는 파드의 개수
  - 즉, 두 필드의 값이 1이면 한 번에 파드 하나만 실행, 정상적으로 종료되어야 하는 파드의 개수도 1개이므로 **단일잡**
- 완료 개수가 있는 병렬 잡
  - completions 필드 값으로 양수를 설정, 필드 값이 1이면 **정상적으로 실행 종료된 파드가 1개만 생겨도 잡이 완료**
  - parallelism: 설정하지 않거나 기본 값으로 설정
- 워크 큐가 있는 병렬 잡
  - completions 필드는 설정하지 않고 parallelism 필드는 양수로 설정
  - completions 필드 값을 설정하지 않으면 기본 값이 parallelism 필드와 동일하게 설정됨
  - 파드 각각은 정상적으로 실행 종료됐는지를 독립적으로 결정 가능
    - 대기열에 있는 작업들이 모두 동시에 실행될 수 있음
  - **파드 하나라도 정상적으로 실행 종료 시 새로운 파드가 실행되지 않음**

  ## 비정상적으로 실행 종료된 파드 관리
  - `.spec.template.spec.restartPolicy`
  - 파드 안에 비정상적으로 실행 종료된 컨테이너가 있을 때를 대비해 재시작 정책 설정
  - 필드 값을 `OnFailure`로 설정해서 컨테이너를 재시작할 수 있음
  - 필드 값을 `Never`로 설정해서 재시작을 막을 수 있음
    - 재시작을 막으면 잡에서 새로운 파드를 실행
  - 이전 파드에서 처리 중이던 상태를 인식하여 잘 처리할 수 있는 설계 필요
    parallelism, completions 값을 1, 재시작 정책 값을 Never로 설정 시 같은 프로그램이 2번 실행될 수 있다.
    - parallelism, completions값을 모두 1보다 크게 설정하면 한 번에 여러 개 파드가 실행될 수 있다.

## 잡 종료 및 정리
- 잡이 정상적으로 실행 종료 시 파드가 새로 생성, 삭제되지 않음
- 잡이 종료되어도 잡은 남아 있음
  - 파드나 잡이 삭제되지 않고 남아있으면 로그를 확인할 수 있고, 잡의 상태를 확인할 수 있음 (분석 가능)
- `.spec.activeDeadlineSeconds`
  - 특정 시간을 지정해 잡 실행을 종료, 잡을 강제로 끝내고 모든 파드 실행 종료
  - 시간을 지정해 잡 실행을 끝냈다면 종료 이유가 `reason: DeadlineExceeded`로 표시됨
- 잡 삭제는 `kubectl delete job {jobName}`
  - 잡을 삭제하면 관련 파드들도 같이 삭제

## 잡 패턴
- 잡에서 파드를 병렬로 실행되면 파드 각각이 서로 통신하지 않음
- 잡은 모든 작업을 관리하는 **잡 하나를 사용**하는 것이 좋다
  - 잡을 생성하는 오버헤드가 큼
  - 그러므로 잡 하나가 여러 개 작업을 처리하는 것이 좋다
- 작업 개수만큼의 파드를 생성하는 것보다 **파드 하나가 여러 개의 작업을 처리하는 것이 좋다**
  - 파드를 생성하는 오버헤드도 크다
  - 그러므로 작업이 많으면 파드 하나가 여러 개 작업을 처리하는 것이 좋다
- 워크 큐를 사용한다면 카프카 등과 같은 **큐 서비스로 워크 큐를 구현하도록 기존 프로그램이나 컨테이너를 수정**해야 함
  - 워크 큐를 사용하지 않으면 기본 설정 그대로 컨테이너를 사용